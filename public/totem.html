<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MapaFácil Market – Totem</title>
  <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
  <header>
    <div><strong>MapaFácil Market</strong> <span class="badge">Totem</span></div>
    <nav class="toolbar">
      <a class="button secondary" href="/admin">Admin</a>
    </nav>
  </header>
  <div class="container">
    <div class="row">
      <div class="card">
        <div class="toolbar">
          <input class="input" id="query" placeholder="Busque por nome, categoria ou corredor"/>
        </div>
        <div id="mapWrap" class="map-wrap" style="margin-top:12px;">
          <img id="mapImg" alt="Mapa" style="width:100%; height:auto; display:none; user-select:none; pointer-events:none;"/>
          <div id="pins" style="position:absolute; inset:0;"></div>
          <svg id="overlay" style="position:absolute; inset:0; pointer-events:none;" width="100%" height="100%"></svg>
        </div>
      </div>
      <div class="card">
        <h3>Resultados</h3>
        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { percentToPx, arrowHead } from '/js/utils.js';

    const img = document.getElementById('mapImg');
    const mapWrap = document.getElementById('mapWrap');
    const pins = document.getElementById('pins');
    const overlay = document.getElementById('overlay');
    const list = document.getElementById('list');
    const queryEl = document.getElementById('query');

    let products = [];
    let config = { mapImage: "", entrance: {x:5,y:95} };
    let activeId = null;

    async function loadAll(){
      products = await (await fetch('/api/products')).json();
      config = await (await fetch('/api/config')).json();
      renderMap();
      renderList();
    }

    function renderMap(){
      overlay.innerHTML = '';
      pins.innerHTML = '';
      if (config.mapImage){
        img.src = config.mapImage;
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }
      const entPx = percentToPx(mapWrap, config.entrance);
      addPin(entPx.x, entPx.y, 'Você está aqui');

      if (activeId){
        const p = products.find(pp => pp.id === activeId);
        if (p && p.x!=null && p.y!=null){
          const px = percentToPx(mapWrap, {x:p.x, y:p.y});
          addPin(px.x, px.y, p.name);
          // linha tracejada + seta
          const line = document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1', entPx.x); line.setAttribute('y1', entPx.y);
          line.setAttribute('x2', px.x);    line.setAttribute('y2', px.y);
          line.setAttribute('stroke', 'black');
          line.setAttribute('stroke-width', '2');
          line.setAttribute('stroke-dasharray', '6 6');
          overlay.appendChild(line);
          const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
          poly.setAttribute('points', arrowHead(entPx, px));
          poly.setAttribute('fill', 'black');
          overlay.appendChild(poly);

          // bolinha animada indo/voltando (CSS animation via SMIL fallback simples)
          const dot = document.createElement('div');
          dot.style.position = 'absolute';
          dot.style.width = '8px';
          dot.style.height = '8px';
          dot.style.borderRadius = '999px';
          dot.style.background = '#111';
          dot.style.transition = 'all 1.2s ease-in-out';
          pins.appendChild(dot);
          let forward = true;
          setInterval(()=>{
            if (forward) { dot.style.left = px.x-4+'px'; dot.style.top = px.y-4+'px'; }
            else { dot.style.left = entPx.x-4+'px'; dot.style.top = entPx.y-4+'px'; }
            forward = !forward;
          }, 1200);
          dot.style.left = entPx.x-4+'px'; dot.style.top = entPx.y-4+'px';
        }
      }
    }

    function addPin(x,y,label){
      const pin = document.createElement('div');
      pin.className = 'pin';
      pin.style.left = x+'px';
      pin.style.top = y+'px';
      pin.innerHTML = '<div class=\"pin-pulse\"></div><div class=\"pin-dot\"></div><div class=\"pin-label\">'+label+'</div>';
      pins.appendChild(pin);
    }

    function renderList(){
      list.innerHTML = '';
      const q = (queryEl.value||'').toLowerCase().trim();
      const items = products.filter(p => {
        return !q || p.name.toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q) || (p.aisle||'').toLowerCase().includes(q);
      });
      if (items.length===0){
        const empty = document.createElement('div');
        empty.className = 'small';
        empty.textContent = 'Nada encontrado.';
        list.appendChild(empty);
        return;
      }
      items.forEach(p=>{
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px;">
            ${p.photo? `<img src="${p.photo}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;"/>` : `<div style="width:48px;height:48px;background:#e5e7eb;border-radius:8px;"></div>`}
            <div style="flex:1">
              <div><strong>${p.name}</strong></div>
              <div class="small">${p.category || 'Sem categoria'} ${p.aisle? ' • Corredor '+p.aisle:''} ${p.shelf? ' • Prateleira '+p.shelf:''} ${p.side? ' • '+p.side:''}</div>
            </div>
            <button class="button secondary" data-act="ver">ver no mapa</button>
          </div>
        `;
        item.querySelector('[data-act="ver"]').onclick = () => { activeId = p.id; renderMap(); };
        list.appendChild(item);
      });
    }

    queryEl.addEventListener('input', renderList);
    loadAll();
  </script>
</body>
</html>
