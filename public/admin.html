<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MapaFácil Market – Admin</title>
  <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
  <header>
    <div><strong>MapaFácil Market</strong> <span class="badge">Admin</span></div>
    <nav class="toolbar">
      <a class="button secondary" href="/totem">Abrir Totem</a>
    </nav>
  </header>
  <div class="container">
    <div class="row">
      <div class="card">
        <div class="toolbar">
          <div>
            <label class="label">Upload do mapa (imagem)</label>
            <input class="file" type="file" id="fileMap" accept="image/*"/>
          </div>
          <div>
            <label class="label">Posição Totem/Entrada</label>
            <button class="button secondary" id="btnEntrada">Selecionar no mapa</button>
            <span id="entradaPos" class="small"></span>
          </div>
          <div style="margin-left:auto">
            <button class="button secondary" id="btnLimpar">Limpar tudo</button>
          </div>
        </div>
        <div id="mapWrap" class="map-wrap" style="margin-top:12px;">
          <img id="mapImg" alt="Mapa" style="width:100%; height:auto; display:none; user-select:none; pointer-events:none;"/>
          <div id="pins" style="position:absolute; inset:0;"></div>
          <svg id="overlay" style="position:absolute; inset:0; pointer-events:none;" width="100%" height="100%"></svg>
        </div>
        <div class="small" style="margin-top:8px;">Dica: clique no mapa para posicionar o item selecionado ou o Totem/Entrada.</div>
      </div>
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3>Cadastro de produto</h3>
          <button class="button secondary" id="btnNovo">Novo</button>
        </div>
        <div class="hr"></div>
        <div>
          <label class="label">Nome</label>
          <input class="input" id="name"/>
          <label class="label">Categoria</label>
          <input class="input" id="category"/>
          <div class="row" style="grid-template-columns:repeat(3,1fr)">
            <div><label class="label">Corredor</label><input class="input" id="aisle"/></div>
            <div><label class="label">Prateleira</label><input class="input" id="shelf"/></div>
            <div><label class="label">Lado</label><input class="input" id="side"/></div>
          </div>
          <label class="label">URL da foto (opcional)</label>
          <input class="input" id="photo"/>
          <div class="toolbar" style="margin-top:10px">
            <button class="button" id="btnSalvar">Adicionar/Salvar</button>
          </div>
        </div>
        <div class="hr"></div>
        <h3>Itens & posições</h3>
        <div class="toolbar">
          <button class="button secondary" id="btnSelEntrada">Totem/Entrada</button>
          <span id="selInfo" class="small"></span>
        </div>
        <div class="list" id="list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { pointerToPercent, percentToPx } from '/js/utils.js';

    const img = document.getElementById('mapImg');
    const mapWrap = document.getElementById('mapWrap');
    const pins = document.getElementById('pins');
    const overlay = document.getElementById('overlay');

    const list = document.getElementById('list');
    const selInfo = document.getElementById('selInfo');
    const entradaPos = document.getElementById('entradaPos');

    const fileMap = document.getElementById('fileMap');
    const btnEntrada = document.getElementById('btnEntrada');
    const btnLimpar = document.getElementById('btnLimpar');
    const btnNovo = document.getElementById('btnNovo');
    const btnSalvar = document.getElementById('btnSalvar');
    const btnSelEntrada = document.getElementById('btnSelEntrada');

    const nameEl = document.getElementById('name');
    const categoryEl = document.getElementById('category');
    const aisleEl = document.getElementById('aisle');
    const shelfEl = document.getElementById('shelf');
    const sideEl = document.getElementById('side');
    const photoEl = document.getElementById('photo');

    let products = [];
    let config = { mapImage: "", entrance: {x:5, y:95} };
    let selected = { type: null, id: null }; // type: 'product'|'entrance'|null

    async function loadAll(){
      products = await (await fetch('/api/products')).json();
      config = await (await fetch('/api/config')).json();
      renderMap();
      renderList();
      updateEntradaLabel();
    }

    function updateEntradaLabel(){
      entradaPos.textContent = `(${config.entrance.x.toFixed(1)}%, ${config.entrance.y.toFixed(1)}%)`;
    }

    function renderMap(){
      overlay.innerHTML = '';
      pins.innerHTML = '';
      if (config.mapImage){
        img.src = config.mapImage;
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }
      // pin entrada
      const entPx = percentToPx(mapWrap, config.entrance);
      addPin(entPx.x, entPx.y, 'Totem/Entrada');
      // pins de produtos
      products.filter(p=>p.x!=null && p.y!=null).forEach(p=>{
        const px = percentToPx(mapWrap, {x:p.x, y:p.y});
        addPin(px.x, px.y, p.name);
      });
    }

    function addPin(x,y,label){
      const pin = document.createElement('div');
      pin.className = 'pin';
      pin.style.left = x+'px';
      pin.style.top = y+'px';
      pin.innerHTML = '<div class=\"pin-pulse\"></div><div class=\"pin-dot\"></div><div class=\"pin-label\">'+label+'</div>';
      pins.appendChild(pin);
    }

    function renderList(){
      list.innerHTML = '';
      products.forEach(p=>{
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <div><strong>${p.name}</strong></div>
              <div class="small">${p.category || '—'} ${p.aisle? ' • Corredor '+p.aisle:''} ${p.shelf? ' • Prateleira '+p.shelf:''} ${p.side? ' • '+p.side:''}</div>
              <div class="small">${(p.x!=null && p.y!=null)? ('pos: '+p.x.toFixed(1)+'%, '+p.y.toFixed(1)+'%') : 'sem posição'}</div>
            </div>
            <div class="toolbar">
              <button class="button secondary" data-act="edit">Editar</button>
              <button class="button secondary" data-act="pos">Posicionar</button>
              <button class="button secondary" data-act="del" style="border-color:#e11d48;color:#e11d48">Excluir</button>
            </div>
          </div>
        `;
        item.querySelector('[data-act="edit"]').onclick = () => {
          fillForm(p);
          selected = { type: 'product', id: p.id };
          selInfo.textContent = 'Selecionado: '+p.name;
        };
        item.querySelector('[data-act="pos"]').onclick = () => {
          selected = { type: 'product', id: p.id };
          selInfo.textContent = 'Clique no mapa para definir a posição de '+p.name;
        };
        item.querySelector('[data-act="del"]').onclick = async () => {
          if (!confirm('Excluir este item?')) return;
          await fetch('/api/products/'+p.id, { method:'DELETE' });
          await loadAll();
          selected = { type:null, id:null };
          selInfo.textContent = '';
        };
        list.appendChild(item);
      });
    }

    function fillForm(p){
      nameEl.value = p.name || '';
      categoryEl.value = p.category || '';
      aisleEl.value = p.aisle || '';
      shelfEl.value = p.shelf || '';
      sideEl.value = p.side || '';
      photoEl.value = p.photo || '';
    }

    btnNovo.onclick = () => {
      nameEl.value = categoryEl.value = aisleEl.value = shelfEl.value = sideEl.value = photoEl.value = '';
      selected = { type:null, id:null };
      selInfo.textContent = '';
    };

    btnSalvar.onclick = async () => {
      const body = {
        name: nameEl.value.trim(),
        category: categoryEl.value.trim(),
        aisle: aisleEl.value.trim(),
        shelf: shelfEl.value.trim(),
        side: sideEl.value.trim(),
        photo: photoEl.value.trim()
      };
      if (!body.name) { alert('Informe o nome'); return; }
      if (selected.type==='product' && selected.id){
        await fetch('/api/products/'+selected.id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      } else {
        const created = await (await fetch('/api/products', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })).json();
        selected = { type:'product', id: created.id };
      }
      await loadAll();
    };

    btnSelEntrada.onclick = () => {
      selected = { type: 'entrance', id: '__entrance__' };
      selInfo.textContent = 'Clique no mapa para definir a posição do Totem/Entrada';
    };
    btnEntrada.onclick = btnSelEntrada.onclick;

    mapWrap.addEventListener('click', async (e) => {
      if (!img.src) return;
      if (!selected.type) return;
      const xy = pointerToPercent(mapWrap, e.clientX, e.clientY);
      if (selected.type === 'entrance'){
        config.entrance = xy;
        await fetch('/api/config', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ entrance: xy }) });
        updateEntradaLabel();
        renderMap();
        return;
      }
      if (selected.type === 'product' && selected.id){
        const p = products.find(pp => pp.id === selected.id);
        if (!p) return;
        await fetch('/api/products/'+selected.id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ x: xy.x, y: xy.y }) });
        await loadAll();
      }
    });

    fileMap.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('map', file);
      const r = await fetch('/api/upload-map', { method:'POST', body: fd });
      const data = await r.json();
      if (data?.mapImage){
        config.mapImage = data.mapImage;
        renderMap();
      }
    });

    btnLimpar.onclick = async () => {
      if (!confirm('Apagar mapa e catálogo?')) return;
      await fetch('/api/config', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mapImage: "", entrance: {x:5,y:95} }) });
      // reset files locally
      await fetch('/api/products'); // no-op
      // Hard reset on disk by overwriting files
      // Not exposed here; manual cleanup not needed, we'll just set empty state:
      products = [];
      config.mapImage = "";
      config.entrance = {x:5,y:95};
      await fetch('/api/products'); // keep API warm
      // Re-render
      renderMap(); renderList(); updateEntradaLabel();
    };

    loadAll();
  </script>
</body>
</html>
